{"version":3,"file":"fromRef.spec.js","sourceRoot":"","sources":["../../../../src/database/observable/fromRef.spec.ts"],"names":[],"mappings":"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","sourcesContent":["import { Reference } from '@firebase/database-types';\nimport { FirebaseApp, FirebaseAppConfig, AngularFireModule } from 'angularfire2';\nimport { AngularFireDatabase, AngularFireDatabaseModule, fromRef } from 'angularfire2/database';\nimport { TestBed, inject } from '@angular/core/testing';\nimport { COMMON_CONFIG } from '../test-config';\n\n// generate random string to test fidelity of naming\nconst rando = () => (Math.random() + 1).toString(36).substring(7);\nconst FIREBASE_APP_NAME = rando();\n\ndescribe('fromRef', () => {\n  let app: FirebaseApp;\n  let ref: (path: string) => Reference;\n  let batch = {};\n  const items = [{ name: 'one' }, { name: 'two' }, { name: 'three' }].map(item => ( { key: rando(), ...item } ));\n  Object.keys(items).forEach(function (key) {\n    const itemValue = items[key];\n    batch[itemValue.key] = itemValue;\n  });\n  // make batch immutable to preserve integrity\n  batch = Object.freeze(batch);\n\n  beforeEach(() => {\n    TestBed.configureTestingModule({\n      imports: [\n        AngularFireModule.initializeApp(COMMON_CONFIG, FIREBASE_APP_NAME),\n        AngularFireDatabaseModule\n      ]\n    });\n    inject([FirebaseApp], (app_: FirebaseApp) => {\n      app = app_;\n      app.database().goOffline();\n      ref = (path: string) => { app.database().goOffline(); return app.database().ref(path); };\n    })();\n  });\n\n  afterEach(done => {\n    app.delete().then(done, done.fail);\n  });\n\n  it('it should be async', (done) => {\n    const itemRef = ref(rando());\n    itemRef.set(batch);\n    const obs = fromRef(itemRef, 'value');\n    let count = 0;\n    expect(count).toEqual(0);\n    const sub = obs.subscribe(change => {\n      count = count + 1;\n      expect(count).toEqual(1);\n      done();\n      sub.unsubscribe();\n    });\n    expect(count).toEqual(0);\n  });\n\n  it('it should should handle non-existence', (done) => {\n    const itemRef = ref(rando());\n    itemRef.set({});\n    const obs = fromRef(itemRef, 'value');\n    const sub = obs.take(1).subscribe(change => {\n      expect(change.payload.exists()).toEqual(false);\n      expect(change.payload.val()).toEqual(null);\n    }).add(done);\n  });\n\n  it('once should complete', (done) => {\n    const itemRef = ref(rando());\n    itemRef.set(batch);\n    const obs = fromRef(itemRef, 'value', 'once');\n    obs.subscribe(change => {}, () => {}, done);\n  });\n\n  it('it should listen and then unsubscribe', (done) => {\n    const itemRef = ref(rando());\n    itemRef.set(batch);\n    const obs = fromRef(itemRef, 'value');\n    let count = 0;\n    const sub = obs.subscribe(change => {\n      count = count + 1;\n      // hard coding count to one will fail if the unsub\n      // doesn't actually unsub\n      expect(count).toEqual(1);\n      done();\n      sub.unsubscribe();\n      itemRef.push({ name: 'anotha one' });\n    });\n  });\n\n  describe('events', () => {\n\n    it('should stream back a child_added event', async (done: any) => {\n      const itemRef = ref(rando());\n      itemRef.set(batch);\n      const obs = fromRef(itemRef, 'child_added');\n      let count = 0;\n      const sub = obs.subscribe(change => {\n        count = count + 1;\n        const { type, payload } = change;\n        expect(type).toEqual('child_added');\n        expect(payload.val()).toEqual(batch[payload.key!]);\n        if (count === items.length) {\n          done();\n          sub.unsubscribe();\n          expect(sub.closed).toEqual(true);\n        }\n      });\n    });\n\n    it('should stream back a child_changed event', async (done: any) => {\n      const itemRef = ref(rando());\n      itemRef.set(batch);\n      const obs = fromRef(itemRef, 'child_changed');\n      const name = 'look at what you made me do';\n      const key = items[0].key;\n      const sub = obs.subscribe(change => {\n        const { type, payload } = change;\n        expect(type).toEqual('child_changed');\n        expect(payload.key).toEqual(key);\n        expect(payload.val()).toEqual({ key, name });\n        sub.unsubscribe();\n        done();\n      });\n      itemRef.child(key).update({ name });\n    });\n\n    it('should stream back a child_removed event', async (done: any) => {\n      const itemRef = ref(rando());\n      itemRef.set(batch);\n      const obs = fromRef(itemRef, 'child_removed');\n      const key = items[0].key;\n      const name = items[0].name;\n      const sub = obs.subscribe(change => {\n        const { type, payload } = change;\n        expect(type).toEqual('child_removed');\n        expect(payload.key).toEqual(key);\n        expect(payload.val()).toEqual({ key, name });\n        sub.unsubscribe();\n        done();\n      });\n      itemRef.child(key).remove();\n    });\n\n    it('should stream back a child_moved event', async (done: any) => {\n      const itemRef = ref(rando());\n      itemRef.set(batch);\n      const obs = fromRef(itemRef, 'child_moved');\n      const key = items[2].key;\n      const name = items[2].name;\n      const sub = obs.subscribe(change => {\n        const { type, payload } = change;\n        expect(type).toEqual('child_moved');\n        expect(payload.key).toEqual(key);\n        expect(payload.val()).toEqual({ key, name });\n        sub.unsubscribe();\n        done();\n      });\n      itemRef.child(key).setPriority(-100, () => {});\n    });\n\n    it('should stream back a value event', (done: any) => {\n      const itemRef = ref(rando());\n      itemRef.set(batch);\n      const obs = fromRef(itemRef, 'value');\n      const sub = obs.subscribe(change => {\n        const { type, payload } = change;\n        expect(type).toEqual('value');\n        expect(payload.val()).toEqual(batch);\n        done();\n        sub.unsubscribe();\n        expect(sub.closed).toEqual(true);\n      });\n    });\n\n    it('should stream back query results', (done: any) => {\n      const itemRef = ref(rando());\n      itemRef.set(batch);\n      const query = itemRef.orderByChild('name').equalTo(items[0].name);\n      const obs = fromRef(query, 'value');\n      const sub = obs.subscribe(change => {\n        let child;\n        change.payload.forEach(snap => { child = snap.val(); return true; });\n        expect(child).toEqual(items[0]);\n        done();\n      });\n    });\n\n  });\n\n});\n"]}